controller:
  serviceAccount: # this serviceAccount would be used by `repocreds`, image updater is set in another values.yaml (inside image-updater)
    annotations:
      eks.amazonaws.com/role-arn: "arn:aws:iam::350206045032:role/ArgoCDRole" # `argocd-application-controller` assigned to argocd-secrets-global right now
  nodeSelector:
    role: ci-cd
# init containers or sidecars that configure or bootstrap the main containers based on dynamic inputs from secrets.
#  envFrom:
#   - configMapRef:
#       name: aws-account

crds:
  keep: false # check # Keep CRDs on chart uninstall

global:
  domain: argocd.tbalza.net # Used for ingresses, certificates, SSO, notifications, etc. (blank allows all domains) # check if it can be replaced by ingress
  image:
    tag: "v2.11.4" # Overrides the global Argo CD image tag whose default is the chart appVersion
#  nodeSelector:
#    role: ci-cd
  # use global node selector # pending

configs:
  cm:
    kustomize.buildOptions: "--load-restrictor LoadRestrictionsNone --enable-helm" # Enable Kustomize to install helm charts
  params:
    server.insecure: true # necessary when SSL termination is handled by ALB
  cmp: # aws-account-substitution plugin. needed since kustomize can't retrieve remote values (secrets/configmaps) for its own installation (only for resulting pods etc.)
    create: true
    plugins: # Plugin yaml files to be added to argocd-cmp-cm
      substitution: # name can't have hyphens # # argocd prepends ARGOCD_ENV_ to configmap key
#        init:
#          command: #
#          args: #
        generate:
          command: ["sh", "-c"] # ["/bin/sh"]
          args: ["set -o pipefail; kustomize build --enable-helm . | cat"] # "set -o pipefail; kustomize build . | envsubst" # ["-c", "kustomize build . | envsubst"]
          #args: ["source /etc/config/env && kustomize build --load-restrictor LoadRestrictionsNone --enable-helm . | envsubst"]
        discover:
          find:
            glob: "**/serviceaccount.yaml"
        #secondpluginexample:
#           find:
#           glob: "**/Chart.yaml"
#           command: [sh, -c, find . -name env.yaml]

server:
#  envFrom:
#    - configMapRef:
#        name: aws-account
  ingress: # working helm ingress with externalDNS as per https://github.com/argoproj/argo-helm/tree/main/charts/argo-cd # no grpc warning errors
    enabled: false # true

applicationSet:
  enabled: true
  nodeSelector:
    role: ci-cd
  extraEnvFrom:
     - configMapRef:
         name: global-variables

dex:
  enabled: false # This is for SSO
  server:
    nodeSelector:
      role: ci-cd

notifications:
  controller:
    nodeSelector:
      role: ci-cd

repoServer:
  serviceAccount: # this serviceAccount would be used by `repocreds`, image updater is set in another values.yaml (inside image-updater)
    annotations:
      eks.amazonaws.com/role-arn: "arn:aws:iam::350206045032:role/ArgoCDRole" # `argocd-application-controller` assigned to argocd-secrets-global right now
  nodeSelector:
    role: ci-cd
  initContainers:
    - name: install-tools
      image: alpine:latest
      command: [ "/bin/sh", "-c" ]
      args:
        - |
          # Update and install necessary packages
          apk add --no-cache curl gettext
          
          # Download and install Kustomize
          curl -L "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv5.4.2/kustomize_v5.4.2_linux_amd64.tar.gz" | tar -xz -C /usr/local/bin
          
          # Ensure envsubst is available from gettext
          ln -s /usr/bin/envsubst /usr/local/bin/envsubst
          
          # Ensure the tools are executable
          chmod +x /usr/local/bin/kustomize /usr/local/bin/envsubst
      volumeMounts:
        - mountPath: /usr/local/bin
          name: tool-bin
  extraContainers: # all of this is default required installation params for cmp, only the plugin yaml name needs to be defined
    - name: substitution
      command:
#        - "/bin/sh"
#        - "-c"
        - "/var/run/argocd/argocd-cmp-server"
      image: alpine:latest
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
      volumeMounts:
        - mountPath: /var/run/argocd
          name: var-files
        - mountPath: /home/argocd/cmp-server/plugins
          name: plugins
        - mountPath: /home/argocd/cmp-server/config/plugin.yaml  # Comment about the necessity of this mount
          subPath: substitution.yaml  # Maps the specific config file for this plugin
          name: argocd-cmp-cm
        - mountPath: /tmp
          name: cmp-tmp
        - mountPath: /usr/local/bin
          name: tool-bin
  volumes:
    - name: argocd-cmp-cm
      configMap:
        name: argocd-cmp-cm
    - name: cmp-tmp # scratch space for any temporary processing
      emptyDir: { }
    - name: tool-bin
      emptyDir: { }
  envFrom: # set environment variable from configmap, probably not needed if using envsubst with cmp
    - configMapRef:
        name: global-variables # previously set as configmap in terraform (with key AWS_ACCOUNT_ID) which dynamically sets aws acct number, for argocd cmp to consume # pending. Use ESO, SSM parameter

