controller:
  serviceAccount: # this serviceAccount would be used by `repocreds`, image updater is set in another values.yaml (inside image-updater)
    annotations:
      eks.amazonaws.com/role-arn: "arn:aws:iam::350206045032:role/ArgoCDRole" # `argocd-application-controller` assigned to argocd-secrets-global right now
  nodeSelector:
    role: ci-cd

crds:
  keep: false # check # Keep CRDs on chart uninstall

global:
  domain: argocd.tbalza.net # Used for ingresses, certificates, SSO, notifications, etc. (blank allows all domains) # check if it can be replaced by ingress
  image:
    tag: "v2.11.4" # Overrides the global Argo CD image tag whose default is the chart appVersion

configs: # use `lovely-plugin` for envsubst instead of injecting envsubst w/ busybox? https://github.com/crumbhole/argocd-lovely-plugin
  cm:
    kustomize.buildOptions: "--load-restrictor LoadRestrictionsNone --enable-helm" # Enable Kustomize to install helm charts
  params:
    server.insecure: true # necessary when SSL termination is handled by ALB
  cmp: # aws-account-substitution plugin. needed since kustomize can't retrieve remote values (secrets/configmaps) for its own installation (only for resulting pods etc.)
    create: true
    plugins: # Plugin yaml files to be added to argocd-cmp-cm
      substitution: # name can't have hyphens # # argocd prepends ARGOCD_ENV_ to configmap key
        generate:
          command: ["sh", "-c"] # ["/bin/sh"]
          args: ["kustomize build --enable-helm"] # "set -o pipefail; kustomize build . | envsubst" # ["-c", "kustomize build . | envsubst"]
#        discover:
#          fileName: "../jenkins/*.yaml"
#  repositories:
#    main-repo:
#      url: https://github.com/tbalza/kubernetes-cicd

server:
  ingress: # working helm ingress with externalDNS as per https://github.com/argoproj/argo-helm/tree/main/charts/argo-cd # no grpc warning errors
    enabled: false # true

applicationSet:
  enabled: true
  nodeSelector:
    role: ci-cd

dex:
  enabled: false # This is for SSO
  server:
    nodeSelector:
      role: ci-cd

notifications:
  controller:
    nodeSelector:
      role: ci-cd

repoServer:
  serviceAccount: # this serviceAccount would be used by `repocreds`, image updater is set in another values.yaml (inside image-updater)
    annotations:
      eks.amazonaws.com/role-arn: "arn:aws:iam::350206045032:role/ArgoCDRole" # `argocd-application-controller` assigned to argocd-secrets-global right now
  nodeSelector:
    role: ci-cd
  extraContainers: # all of this is default required installation params for cmp, only the plugin yaml name and envsubst need to be defined as additional mounts
    - name: substitution
      command:
        - "/var/run/argocd/argocd-cmp-server"
      image: quay.io/argoproj/argocd # '{{ default .Values.global.image.repository .Values.repoServer.image.repository }}:{{ default (include "argo-cd.defaultTag" .) .Values.repoServer.image.tag }}'
      securityContext:
        runAsNonRoot: true # true
        runAsUser: 999 # 999
      volumeMounts:
        - mountPath: /var/run/argocd
          name: var-files
        - mountPath: /home/argocd/cmp-server/plugins
          name: plugins
        - mountPath: /home/argocd/cmp-server/config/plugin.yaml
          subPath: substitution.yaml  # Maps the specific config file for this plugin
          name: argocd-cmp-cm
        - mountPath: /tmp
          name: cmp-tmp
        - mountPath: /usr/local/bin # envsubst
          name: custom-tools
  volumes: # only the shared-bin(envsubst) needs to be defined as additional mount
    - name: argocd-cmp-cm
      configMap:
        name: argocd-cmp-cm
    - name: cmp-tmp # scratch space for any temporary processing
      emptyDir: {}
    - name: custom-tools # envsubst
      emptyDir: {}
  initContainers: # # envsubst
    - name: install-envsubst
      image: tbalza/envsubst:latest
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
      command: [ "sh", "-c" ]
      args:
        - "cp envsubst /custom-tools/envsubst && chmod +x /custom-tools/envsubst"
  volumeMounts:
    - mountPath: /custom-tools
      name: custom-tools


#  envFrom: # set environment variable from configmap, probably not needed if using envsubst with cmp
#    - configMapRef:
#        name: global-variables # previously set as configmap in terraform (with key AWS_ACCOUNT_ID) which dynamically sets aws acct number, for argocd cmp to consume # pending. Use ESO, SSM parameter

